<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
		"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>doh.robot ComboBox/FilteringSelect Test</title>

	<style>
		@import "../../../../util/doh/robot/robot.css";
	</style>

	<!-- required: dojo.js -->
	<script type="text/javascript" src="../../../../dojo/dojo.js"
		djConfig="isDebug: true, parseOnLoad: true"></script>
	<script type="text/javascript" src="../../helpers.js"></script>

	<script type="text/javascript">
		dojo.require("dijit.dijit"); // optimize: load dijit layer
		dojo.require("dijit.robotx");

		// TODO: provide URL toggle for FilteringSelect
		var testWidget = "dijit.form.ComboBox";
		var qstr = window.location.search.substr(1);
		if(qstr.length){
		        var qparts = qstr.split("&");
		        for(var x=0; x<qparts.length; x++){
		                var tp = qparts[x].split("=");
		                if(tp[0] == "testWidget"){
		                        testWidget = tp[1];
		                }
		        }
		}
		isComboBox = testWidget=="dijit.form.ComboBox";
		dojo.addOnLoad(function(){

			doh.robot.initRobot('../_autoComplete.html?testWidget='+testWidget);

			var arrowlessComboBoxes=['arrowless'];

			var robot_typeValue = function(combo, text, value){
				if(!value || isComboBox) value = text;
				var d = new doh.Deferred();
				doh.robot.mouseMoveAt(combo.focusNode, 500);
				doh.robot.mouseClick({left:true}, 500);
				doh.robot.sequence(function(){ combo.attr('value', null); }, 500);
				doh.robot.typeKeys(text.replace(/^(.).*$/, "$1"), 500);
				doh.robot.typeKeys(text.replace(/^./, ""), 1500, text.length);
				doh.robot.keyPress(dojo.keys.ENTER, 1500+text.length*100);
				doh.robot.sequence(function(){
					if(combo.attr('value') == value && combo.focusNode.value == text && !combo._isShowingNow){
						d.callback(true);
					}else{
						if(combo._isShowingNow){
							// menu could arrive after Enter keypress if it is not thrown out
							combo._hideResultList();
							d.errback(combo.id+" had a menu that did not close after an Enter keypress.");
						}else{
							d.errback(combo.id+" was supposed to have a value of "+value+". Text is "+combo.focusNode.value+", value is "+combo.attr('value'));
						}
					}
				}, 2000);
				return d;
			};

			var findMenuItem = function(combo, text){
				var node = combo._popupWidget.domNode.firstChild;
				while(((node.innerText || node.textContent).indexOf(text)<0) && node.nextSibling){
					node = node.nextSibling;
				}
				return node;
			}

			var robot_selectValue = function(combo, text, value, expectedtext){
				if(!value || isComboBox) value = text;
				if(!expectedtext || isComboBox) expectedtext = text;
				var d = new doh.Deferred();
				doh.robot.mouseMoveAt(combo.downArrowNode, 500);
				doh.robot.mouseClick({left:true}, 500);
				var repeat = function(){
					var node = findMenuItem(combo, text);
					var isMoreChoices = node == combo._popupWidget.nextButton;
					doh.robot.mouseMoveAt(node, 500);
					doh.robot.mouseClick({left:true}, 500);
					if(isMoreChoices){
						// can go faster since the data will have loaded by now
						doh.robot.sequence(repeat, 1000);
					}else{
						doh.robot.sequence(function(){
							if(combo.attr('value') == value && combo.focusNode.value == expectedtext){
								d.callback(true);
							}else{
								d.errback(combo.id+" was supposed to have a value of "+value+". Text is "+combo.focusNode.value+", value is "+combo.attr('value'));
							}
						}, 500);
					}
					
				};
				// first time, wait for the data to come in
				doh.robot.sequence(repeat, 3000);
				return d;
			};
			var robot_a11ySelectValue = function(combo, text, value, expectedtext){
				if(!value || isComboBox) value = text;
				if(!expectedtext || isComboBox) expectedtext = text;
				var d = new doh.Deferred();
				
				// TODO: get rid of mouse movement here, can use focus
				doh.robot.mouseMoveAt(combo.focusNode, 500);
				doh.robot.mouseClick({left:true}, 500);
				doh.robot.sequence(function(){ combo.attr('value', null); }, 500);
				doh.robot.keyPress(dojo.keys.DOWN_ARROW, 500);
				var repeat = function(){
					var node = findMenuItem(combo, text);
					var isMoreChoices = node == combo._popupWidget.nextButton;
					var selected = combo._popupWidget.getHighlightedOption() || combo._popupWidget.domNode.firstChild;
					while(selected != node){
						doh.robot.keyPress(dojo.keys.DOWN_ARROW, 100);
						selected = selected.nextSibling;
					}
					doh.robot.keyPress(dojo.keys.ENTER, 500);
					if(isMoreChoices){
						// can go faster since the data will have loaded by now
						doh.robot.sequence(repeat, 1000);
					}else{
						doh.robot.sequence(function(){
							if(combo.attr('value') == value && combo.focusNode.value == expectedtext){
								d.callback(true);
							}else{
								d.errback(combo.id+" was supposed to have a value of "+value+". Text is "+combo.focusNode.value+", value is "+combo.attr('value'));
							}
						}, 500);
					}
					
				};
				// first time, wait for the data to come in
				doh.robot.sequence(repeat, 3000);
				return d;
			};

			var errorTest = function(){
				robot_typeValue((this.combo = dijit.byId(this.combo)), "zxcxarax");
				var d = new doh.Deferred();
				doh.robot.sequence(dojo.hitch(this, function(){
					if(isComboBox){
						if(this.combo.isValid() && this.combo.attr('value') == "zxcxarax"){
							d.callback(true);
						}else{
							d.errback(new Error("Good value flagged as bad in ComboBox"));
						}
					}else{
						if(!this.combo.isValid() && this.combo.attr('value') == ""){
							d.callback(true);
						}else{
							if(this.combo.isValid()){
								d.errback(new Error("Bad value permitted in FilteringSelect. Value is: "+this.combo.attr('value')+", text is:"+this.combo.focusNode.value));
							}else{
								d.errback(new Error("Expected value of '', got "+this.combo.attr('value')));
							}
						}
					}
				}), 3000);
				return d;
			};

			// Wait for data stores to finish loading before starting tests
			dojo.forEach(["store", "store2", "stateStore", "dijitStore"], function(name){
				doh.register("wait for " + name,
					{
						name: "confirm loaded",
						timeout: 5000,
						runTest: function(){
							var d = new doh.Deferred();
							dojo.global[name].fetch({
								onComplete: function(){
									console.log(name + " store loaded...");
									d.callback(true);
								}
							});
							return d;
						}
					}
				);
			});

			// TESTS
			// Verify that all of the form values are correct at init
			doh.register("verify values", 			
				{
					name:"verifyValues",
					runTest:function(){
						// Spot check of initial conditions of widgets and DOM nodes

						doh.is("California", dijit.byId("setvaluetest").attr("displayedValue"), "state1 displayed value");
						doh.is(isComboBox ? "California" : "CA", dijit.byId("setvaluetest").attr("value"), "state1 value");
						doh.is("not fired yet!", dojo.byId("oc1").value, "state1 onChange hasn't fired");

						doh.is(isComboBox ? "California" : "CA", dojo.byId("form1").state2.value, "state2 submit value");

						doh.is(1, dojo.query("input[name=state3]").length,
							"Just one input inside of filteringSelect/combobox w/name specified");
						if(!isComboBox){
							// Filtering select should have two inputs, but the displayed one is hidden
							doh.is(2, dojo.query("input", dijit.byId("combo3").domNode).length,
								"Two inputs inside of filteringSelect");
						}

						doh.is("sticks & stones", dijit.byId("specialchars").attr("displayedValue"), "specialchars attr('displayValue')");
						doh.is(isComboBox ? "sticks & stones" : "sticks", dijit.byId("specialchars").attr("value"), "specialchars value");
						doh.is("sticks & stones", dojo.query("input[id=specialchars]")[0].value, "specialchars display value via DOMNode");
						doh.is(isComboBox ? "sticks & stones" : "sticks", dojo.query("input[name=specialchars]")[0].value, "specialchars submit value via DOMNode");
					}
				}
			);

			// Press button to set value to Kentucky
			// This should be a valid assignment
			doh.register("setvaluetest",
				{
					timeout:5000,
					name:"valid",
					combo:"setvaluetest",
					runTest:function(){
						var d = new doh.Deferred();
						this.combo = dijit.byId(this.combo);
						var oc1=dojo.byId('oc1');
						doh.robot.mouseMoveAt('sv1_1', 500);
						doh.robot.mouseClick({left:true}, 500);
						doh.robot.sequence(dojo.hitch(this, function(){
							if(isComboBox){
								if(this.combo.attr('value') == "Kentucky" && oc1.value == "Kentucky"){
									d.callback(true);
								}else{
									d.errback(new Error("Expected Kentucky, got "+this.combo.attr('value')));
								}
							}else{
								if(this.combo.attr('value') == "KY" && this.combo.isValid() && oc1.value == "KY"){
									d.callback(true);
								}else{
									d.errback(new Error("Expected KY, got "+this.combo.attr('value')));
								}
							}
						}), 2000);
						return d;
					}
				}
			);

			// Press button to set value to Canada
			// This should be an invalid assignment for FilteringSelect, but ok for ComboBox
			doh.register("setvaluetest",
				{
					timeout:5000,
					name:"invalid",
					combo:"setvaluetest",
					runTest:function(){
						var d = new doh.Deferred();
						this.combo = dijit.byId(this.combo);
						var oc1=dojo.byId('oc1');
						doh.robot.mouseMoveAt('sv1_2', 500);
						doh.robot.mouseClick({left:true}, 500);
						doh.robot.sequence(dojo.hitch(this, function(){
							if(isComboBox){
								if(this.combo.attr('value') == "Canada" && oc1.value == "Canada"){
									d.callback(true);
								}else{
									d.errback(new Error("Expected Canada, got "+this.combo.attr('value')));
								}
							}else{
								if(this.combo.attr('value') == "" && !this.combo.isValid() && oc1.value == ""){
									d.callback(true);
								}else{
									d.errback(new Error("Expected Canada, got "+this.combo.attr('value')));
								}
							}
						}), 2000);
						return d;
					}
				}
			);

			// Press button to set value to null
			// This should be an invalid assignment for FilteringSelect, but ok for ComboBox
			doh.register("setvaluetest",
				{
					timeout:5000,
					name:"nullvalue",
					combo:"setvaluetest",
					runTest:function(){
						var d = new doh.Deferred();
						this.combo = dijit.byId(this.combo);
						var oc1=dojo.byId('oc1');
						doh.robot.mouseMoveAt('sv1_3', 500);
						doh.robot.mouseClick({left:true}, 500);
						doh.robot.sequence(dojo.hitch(this, function(){
							if(isComboBox){
								if(this.combo.attr('value') == "" && oc1.value == ""){
									d.callback(true);
								}else{
									d.errback(new Error("Expected '', got "+this.combo.attr('value')));
								}
							}else{
								if(this.combo.attr('value') == "" && !this.combo.isValid() && oc1.value == ""){
									d.callback(true);
								}else{
									d.errback(new Error("Expected '', got "+this.combo.attr('value')));
								}
							}
						}), 2000);
						return d;
					}
				}
			);

			// Type a valid value and press Enter
			doh.register("states",
				{
					timeout:60000,
					name:"setvaluetest_type",
					combo:"setvaluetest",
					runTest:function(){
						return robot_typeValue(dijit.byId(this.combo), "California", "CA");
					}
				}
			);

			// Select a value with the mouse
			doh.register("states",
				{
					timeout:60000,
					name:"setvaluetest_select",
					combo:"setvaluetest",
					runTest:function(){
						return robot_selectValue(dijit.byId(this.combo), "Wyoming", "WY");
					}
				}
			);

			// Select a value with the keyboard
			// TODO: test page-down key too?
			doh.register("states",
				{
					timeout:60000,
					name:"setvaluetest_a11y",
					combo:"setvaluetest",
					runTest:function(){
						return robot_a11ySelectValue(dijit.byId(this.combo), "Texas", "TX");
					}
				}
			);

			// Type an invalid value and press Enter
			doh.register("states",
				{
					timeout:60000,
					name:"setvaluetest_error",
					combo:"setvaluetest",
					runTest:function(){
						return (dojo.hitch(this, errorTest))();
					},
					tearDown:function(){
						this.combo.attr("value", isComboBox?"Alaska":"AK");
					}
				}
			);
		
			// Test that drop down choices are filtered to values matching
			// what user has typed
			doh.register("filtering of drop down", [
				{
					timeout:60000,
					name:"type C",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("setvaluetest");

						// Focus drop down
						doh.robot.mouseMoveAt(combo.focusNode, 500);
						doh.robot.mouseClick({left:true}, 500);

						// Filter drop down list to entries starting with "C"
						doh.robot.sequence(function(){ combo.attr('value', null); }, 500);
						doh.robot.keyPress("C", 100);
						
						doh.robot.sequence(d.getTestCallback(function(){
							// Check that drop down list has appeared, and contains California, Colorado, Connecticut
							var list = dojo.byId("setvaluetest_popup");
							doh.t(list, "drop down exists");
							doh.t(isVisible(list), "drop down is visible");
							
							var entries = dojo.query("li", list).filter(isVisible);
							doh.is(3, entries.length, "three entries in drop down: " + list.innerHTML);
							doh.is("California", innerText(entries[0]), "list #1");						
							doh.is("Colorado", innerText(entries[1]), "list #2");						
							doh.is("Connecticut", innerText(entries[2]), "list #3");
							
							// Check that search-string highlighting is working
							doh.is('<span class="dijitcomboboxhighlightmatch">c</span>onnecticut', entries[2].innerHTML.toLowerCase(),
								"highlighting is working");
						}), 500);
						
						return d;
					}
				},
				{
					timeout:60000,
					name:"type 'o' after 'C'",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("setvaluetest");

						// Filter drop down list to entries starting with "Co"
						doh.robot.keyPress("o", 100);
						
						doh.robot.sequence(d.getTestCallback(function(){
							// Check that drop down list is still there, and California has disappeared
							var list = dojo.byId("setvaluetest_popup");
							doh.t(list, "drop down exists");
							doh.t(isVisible(list), "drop down is visible");
							
							var entries = dojo.query("li", list).filter(isVisible);
							doh.is(2, entries.length, "three entries in drop down: " + list.innerHTML);
							doh.is("Colorado", innerText(entries[0]), "list #1");						
							doh.is("Connecticut", innerText(entries[1]), "list #2");
						}), 500);
						
						return d;
					}
				},
				{
					timeout:60000,
					name:"type backspace",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("setvaluetest");

						doh.robot.keyPress(dojo.keys.BACKSPACE, 100);
						
						doh.robot.sequence(d.getTestCallback(function(){
							console.log("just did backspace");
							// List should again contain California
							var list = dojo.byId("setvaluetest_popup");
							doh.t(list, "drop down exists");
							doh.t(isVisible(list), "drop down is visible");
							
							var entries = dojo.query("li", list).filter(isVisible);
							doh.is(3, entries.length, "three entries in drop down: " + list.innerHTML);
							doh.is("California", innerText(entries[0]), "list #1");						
							doh.is("Colorado", innerText(entries[1]), "list #2");						
							doh.is("Connecticut", innerText(entries[2]), "list #3");

							// Check that search-string highlighting is still working
							doh.is('<span class="dijitcomboboxhighlightmatch">c</span>onnecticut', entries[2].innerHTML.toLowerCase(),
								"highlighting is working")
						}), 500);
						
						return d;
					}
				}

				// TODO: make separate test group for testing highlighting, and then check		
				//     - matching of anywhere in string (id=arrowless)
				//     - highlightmatch=none (combobox4)
			]);

			// Test auto complete
			doh.register("auto-complete", [
				{
					timeout:60000,
					name:"no auto-complete",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("setvaluetest");

						// Focus drop down
						doh.robot.mouseMoveAt(combo.focusNode, 500);
						doh.robot.mouseClick({left:true}, 500);

						// Filter drop down list to entries starting with "C"
						doh.robot.sequence(function(){ combo.attr('value', null); }, 500);
						doh.robot.keyPress("C", 100);
						
						// Then tab away
						doh.robot.keyPress(dojo.keys.TAB, 500);
	
						doh.robot.sequence(d.getTestCallback(function(){
							// Check that drop down list has disappeared
							var list = dojo.byId("setvaluetest_popup");
							doh.t(!list || isHidden(list), "drop down is visible");
							
							// Since autocomplete=false the contents should just be what the user typed
							doh.is('C', combo.focusNode.value);
							if(!isComboBox){
								doh.f(dijit.byId("setvaluetest").isValid(), "FilteringSelect shouldn't be valid");
							}
						}), 500);
						
						return d;
					}
				},
				{
					timeout:60000,
					name:"auto-complete writes suggested letters in input box",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("datatest");	// auto-complete = true

						// Focus drop down
						doh.robot.mouseMoveAt(combo.focusNode, 500);
						doh.robot.mouseClick({left:true}, 500);

						// Filter drop down list to entries starting with "C"
						doh.robot.sequence(function(){ combo.attr('value', null); }, 500);
						doh.robot.keyPress("C", 100);

						doh.robot.sequence(d.getTestCallback(function(){
							var list = dojo.byId("datatest_popup");
							doh.t(isVisible(list), "drop down is visible");

							doh.is('California', combo.focusNode.value, "'alifornia' automatically appended to user input");
						}), 500);
						
						return d;
					}
				},	
				{
					timeout:60000,
					name:"auto-complete changes suggestion based on more typed letters",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("datatest");

						// Further filter drop down to entries starting with "Co" (Colorado and Connectictut).
						// Note that this depends on (and tests that) "alifornia" is selected (aka highlighted),
						// so that the "o" keypress erases it and replaces the input box text with "Co"
						doh.robot.keyPress("o", 100);

						doh.robot.sequence(d.getTestCallback(function(){
							doh.is('Colorado', combo.focusNode.value, "suggestion changed from California to Colorado");
						}), 500);
						
						return d;
					}
				},			
				{
					timeout:60000,
					name:"tab-away auto-selects value",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("datatest");

						// Then tab away
						doh.robot.keyPress(dojo.keys.TAB, 500);
	
						doh.robot.sequence(d.getTestCallback(function(){
							// Check that drop down list has disappeared
							var list = dojo.byId("datatest_popup");
							doh.t(!list || isHidden(list), "drop down is hidden");
				
							doh.is(isComboBox ? "Colorado" : "CO", combo.attr('value'));
							if(!isComboBox){
								doh.t(combo.isValid(), "FilteringSelect should be valid");
							}
						}), 500);
						
						return d;
					}
				}
			]);
			
			// TODO: test "more choices" in drop down (that's tested above indirectly, but test more
			// explicitly)

			// TODO: test ESC key or click on screen background or click on another widget to close drop down
			
			// TODO: test race condition where queries return results in different order than they were executed

			// TODO: test that menu doesn't show up after ENTER keypress
			
			// TODO: click test for arrowless

			// disabled tests+standard tests
			doh.register("disabled", [
			
				// Test that correct styling is applied
				{
					timeout:1000,
					name:"styling",
					combo:"combo3",
					runTest:function(){
						this.combo = dijit.byId(this.combo);
						doh.is(true, this.combo.attr('disabled'));
						doh.is(true, this.combo.focusNode.disabled);
					}
				},

				// Test that you can't type into a disabled combobox
				// TODO: should not be calling typeKeys, as who knows where focus is, and what will happen?
				// Just confirm that can't focus the element.
				{
					timeout:60000,
					name:"typing",
					combo:"combo3",
					runTest:function(){
						var d = new doh.Deferred();
						this.combo = dijit.byId(this.combo);
						doh.robot.mouseMoveAt(this.combo.focusNode, 500);
						doh.robot.mouseClick({left:true}, 500);
						
						doh.robot.typeKeys("Canada", 500);
						// Assert that nothing happened
						doh.robot.sequence(dojo.hitch(this, function(){
							if(this.combo.focusNode.value=="Canada"){
								d.errback(new Error("User was able to type in a disabled ComboBox!"));
							}else{
								d.callback(true);
							}
						}), 2000);
						return d;
					}
				},

				{
					timeout:60000,
					name:"dropdown disabled",
					combo:"combo3",
					runTest:function(){
						var d = new doh.Deferred();
						this.combo = dijit.byId(this.combo);
						// Press Arrow Button
						doh.robot.mouseMoveAt(this.combo.downArrowNode, 500);
						doh.robot.mouseClick({left:true}, 500);
						// Assert that nothing happened
						doh.robot.sequence(dojo.hitch(this, function(){
							if(this.combo._popupWidget){
								d.errback(new Error("User was able to open the menu on a disabled ComboBox!"));
							}else{
								d.callback(true);
							}
						}), 2000);
						return d;
					}
				}
			]);

			// now enable it and do it again
			doh.register("enabled", [
				{
					timeout:30000,
					name:"combo3_enabledStyle",
					combo:"combo3",
					runTest:function(){
						var d = new doh.Deferred();
						
						// click button to enable combobox
						var button = dojo.byId(this.combo+"_disable");
						this.combo = dijit.byId(this.combo);
						doh.robot.mouseMoveAt(button, 500);
						doh.robot.mouseClick({left:true}, 500);
						
						// check styling
						doh.robot.sequence(dojo.hitch(this, function(){
							try{
								doh.is(false, this.combo.attr('disabled'));
								doh.is(false, this.combo.focusNode.disabled);
								d.callback(true);
							}catch(e){
								d.errback(new Error("Wrong style after enabling ComboBox."));
							}
						}), 500);
						return d;
					}
				},

				// Check that selecting a value works
				{
					timeout:60000,
					name:"combo3_select",
					combo:"combo3",
					runTest:function(){
						return robot_selectValue(dijit.byId(this.combo), "Wyoming", "WY");
					}
				}
			]);


			doh.register("specialchars", [
				{
					timeout:60000,
					name:"specialchars_type",
					combo:"specialchars",
					runTest:function(){
						return robot_typeValue(dijit.byId(this.combo), "sticks & stones", "sticks");
					}
				},

				{
					timeout:60000,
					name:"specialchars_a11y",
					combo:"specialchars",
					runTest:function(){
						return robot_a11ySelectValue(dijit.byId(this.combo), "more\\less", "more");
					}
				}
			]);

			doh.register("japanese", [
				{
					timeout:60000,
					name:"japanese_a11y",
					combo:"japanese",
					runTest:function(){
						return robot_a11ySelectValue((this.combo = dijit.byId(this.combo)), "\u6771\u533A (East)", "higashiku");
					},
					tearDown:function(){
						this.combo.attr("value", isComboBox?"\u6771\u533A (East)":"higashiku");
					}
				},

				{
					timeout:60000,
					name:"japanese_type",
					combo:"japanese",
					runTest:function(){
						//return robot_typeValue(, "\u6771\u897F", "touzai");
						var d = new doh.Deferred();
						this.combo = dijit.byId(this.combo);
						doh.robot.mouseMoveAt(this.combo.focusNode);
						doh.robot.mouseClick({left:true}, 500);
						doh.robot.keyPress(dojo.keys.END, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress(dojo.keys.BACKSPACE, 500);
						doh.robot.keyPress('x', 500, {ctrl:true});
						doh.robot.keyPress(dojo.keys.ENTER, 500);
						doh.robot.sequence(dojo.hitch(this, function(){
							if(this.combo.attr('value') == (isComboBox?"\u6771\u897F (Touzai)":"touzai") && this.combo.focusNode.value=="\u6771\u897F (Touzai)"){
								d.callback(true);
							}else{
								d.errback(this.combo.id+" was supposed to have a value of "+(isComboBox?"\u6771\u897F (Touzai)":"touzai")+". Text is "+this.combo.focusNode.value+", value is "+this.combo.attr('value'));
							}
						}), 500);
						return d;
					}
				}
			]);

			doh.register("labelFunc", [
				{
					timeout:60000,
					name:"labelFunc_a11y",
					combo:"labelFunc",
					runTest:function(){
						// labelFunc makes Texas texas on FilteringSelect
						return robot_a11ySelectValue((this.combo = dijit.byId(this.combo)), "Texas", isComboBox?null:"TX", isComboBox?null:"texas");
					},
					tearDown:function(){
						this.combo.attr("value", isComboBox?"Texas":"TX");
					}
				},

				{
					timeout:60000,
					name:"labelFunc_type",
					combo:"labelFunc",
					runTest:function(){
						var d = robot_typeValue((this.combo = dijit.byId(this.combo)), isComboBox?"Alabama":"alabama", "AL");
						return d;
					}
				}
			]);

			// The specifying a sort order and an initial filter to ComboBox
			doh.register("filter and sort params", [
				{
					timeout:60000,
					name:"sort order",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("progCombo3");

						// Focus drop down
						doh.robot.mouseMoveAt(combo.focusNode, 500);
						doh.robot.mouseClick({left:true}, 500);

						// Show list, should be in reverse order
						doh.robot.sequence(function(){ combo.attr('value', null); }, 500);
						doh.robot.keyPress(dojo.keys.DOWN_ARROW, 100);
						
						doh.robot.sequence(d.getTestCallback(function(){
							var list = dojo.byId("progCombo3_popup");
							doh.t(list, "drop down exists");
							doh.t(isVisible(list), "drop down is visible");
							
							var entries = dojo.query("li", list).filter(isVisible);
							doh.is("United States of America", innerText(entries[0]), "list #1");						
						}), 500);
						
						return d;
					}
				},
				{
					timeout:60000,
					name:"initial filter",
					runTest:function(){
						var d = new doh.Deferred();
						var combo = dijit.byId("progCombo3");

						// Filter drop down list to entries starting with "A"
						doh.robot.keyPress("A", 100);
						
						doh.robot.sequence(d.getTestCallback(function(){
							// Check that drop down list *doesn't* contain Africa, just Argentina
							var list = dojo.byId("progCombo3_popup");
							doh.t(list, "drop down exists");
							doh.t(isVisible(list), "drop down is visible");
							
							var entries = dojo.query("li", list).filter(isVisible);
							doh.is(1, entries.length, "only one entry in drop down: " + list.innerHTML);
							doh.is("Argentina", innerText(entries[0]), "list #1");						
						}), 500);
						
						return d;
					}
				}
			]);
			
			doh.run();
		});
	</script>
</head>
</html>

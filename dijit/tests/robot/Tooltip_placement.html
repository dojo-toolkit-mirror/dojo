<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
		"http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>doh.robot tooltip place Test</title>

		<style>
			@import "../../../util/doh/robot/robot.css";
		</style>

		<!-- required: dojo.js -->
		<script type="text/javascript" src="../../../dojo/dojo.js"
			djConfig="isDebug: true, parseOnLoad: true"></script>

		<script type="text/javascript">
			dojo.require("dijit.dijit"); // optimize: load dijit layer
			dojo.require("dijit.robotx");
			
			//Verify the following is true:
			//	1. The tooltip is displayed to the right or the left of the textbox
			//	2. The tooltip arrow is next to the textbox and pointing in the correct direction
			//	3. The user can view the entire tooltip on the screen OR the tootip is displayed on the side with the largest width available
			//	4. If the tooltip is not completely visible, verify that it uses all available height
			function testRightOrLeft(textbox){
				//find the tooltip
				var textboxPos = dojo.position(textbox.domNode);
				var tooltipConnector = dojo.query("div[dojoattachpoint='connectorNode']");
				var tooltipConnectorPos = dojo.position(tooltipConnector[0]);
				var tooltipAndConnectorPos = dojo.position(tooltipConnector[0].parentNode);

				var middleOfTextbox = textboxPos.y + (textboxPos.h / 2);
				var middleOfTooltipConnector = tooltipConnectorPos.y + (tooltipConnectorPos.h /2);
				
				var yDiff = 0;
				var yDiff = middleOfTextbox - middleOfTooltipConnector;
				var yAxisValid = yDiff <= 1 && yDiff >= -1; //tooltip arrow is at a similar y coord as the box
				doh.t(yAxisValid, "Y axis is invalid. yDiff was: "+yDiff);
				
				var xDiff = textboxPos.x - tooltipAndConnectorPos.x - tooltipAndConnectorPos.w;
				var toTheLeft = xDiff >= -0.5 && xDiff < 2;	
				
				xDiff = tooltipAndConnectorPos.x - textboxPos.x - textboxPos.w;
				var toTheRight = xDiff >= -0.5 && xDiff < 2;
				
				doh.t(toTheLeft || toTheRight, "The tooltip was not to the left or right");				
				
				var tooltip = dojo.query("div[dojoattachpoint='containerNode']");
				var tooltipPos = dojo.position(tooltip[0]);

				var view = dojo.window.getBox();
				var isIE6 = dojo.isIE < 7;
				//verify the entire width is utilized.  Small tooltips will not utilize the entire witdth.
				if(doh._currentGroup!="tooltip_left_right_small" && !isIE6 && !dojo.isOpera) {
					if(toTheLeft){
						doh.t(tooltipAndConnectorPos.w + 3/*space in between arrow and textbox*/ >= textboxPos.x, "The entire width was not utilized to the left");						
					}else{
						doh.t(tooltipAndConnectorPos.w + 3/*space in between arrow and textbox*/ >= view.w - tooltipAndConnectorPos.x, "The entire width was not utilized to the right");
					}
				}
				
				//If we cannot view the entire tooltip, verify they side with the most space was choosen and the entire height was utilized.
				var canViewEntireTooltip = (tooltipAndConnectorPos.x + tooltipAndConnectorPos.w <= view.w) && 
				                           (tooltipPos.y + tooltipPos.h <= view.h);
				if(!canViewEntireTooltip && !isIE6 && !dojo.isOpera){
					if(toTheLeft){
						//verify there is more space on the left than the right
						doh.t(textboxPos.x >= (view.w - textboxPos.x - textboxPos.w), "There is not more space on the left than the right");	
					}else{
						doh.t(textboxPos.x <= (view.w - textboxPos.x - textboxPos.w), "There is not more space on the right than the left");
					}
					//verify the entire height is utilized
					doh.t(tooltipPos.h >= view.h, "The entire height was not utilized");
				}
			}
			
			function testAboveBelow(textbox){
				var textboxPos = dojo.position(textbox.domNode);
				var tooltipConnector = dojo.query("div[dojoattachpoint='connectorNode']");
				var tooltipConnectorPos = dojo.position(tooltipConnector[0]);
				var tooltipAndConnectorPos = dojo.position(tooltipConnector[0].parentNode);
				
				var xDiff = 0;
				var xAxisValid = textboxPos.x  <= tooltipConnectorPos.x && tooltipConnectorPos.x <= (textboxPos.x + textboxPos.w);
				doh.t(xAxisValid, "X axis is invalid");
				
				var yDiff = textboxPos.y - tooltipAndConnectorPos.y - tooltipAndConnectorPos.h;
				var above = yDiff >= -0.5 && yDiff < 1;
				
				yDiff = tooltipAndConnectorPos.y - textboxPos.y - textboxPos.h;
				var below = yDiff >= -0.5 && yDiff < 1;
				
				doh.t(above || below);
			}

			dojo.addOnLoad(function(){
				doh.robot.initRobot('../test_Tooltip_placement.html');

				// init tests for each group
				var tooltip_left_right = [{
					name: "test1",
					timeout: 4000,
					runTest: function(){
						var d = new doh.Deferred();
						
						//If windows are very small (in IE6) sometimes they will not get clicked on because they aren't in view
						doh.robot.sequence(function(){ dijit.byId("test1").focus(); }, 500);
						
						doh.robot.keyPress("a", 1000);

						doh.robot.sequence(d.getTestCallback(function(){
							testRightOrLeft(dijit.byId("test1"));
						}), 500);
						return d;
					}
				}];
				var tooltip_left_right_small = [{
					name: "test1_lrs",
					timeout: 6000,
					runTest: function(){
						var d = new doh.Deferred();
						
						doh.robot.sequence(function(){ dijit.byId("test1").focus();}, 500);
						doh.robot.keyPress(dojo.keys.LEFT_ARROW, 500);
						doh.robot.keyPress(dojo.keys.DELETE, 500);
						
						doh.robot.mouseMoveAt("test7", 500);
						doh.robot.mouseClick({left:true}, 500);
						
						doh.robot.sequence(function(){ dijit.byId("test1").focus();}, 500);

						doh.robot.sequence(d.getTestCallback(function(){
							testRightOrLeft(dijit.byId("test1"));
						}), 500);
						return d;
					}
				}];
				var tooltip_above_below_small = [{
					name: "test1_abs",
					timeout: 3000,
					runTest: function(){
						var d = new doh.Deferred();
						
						doh.robot.mouseMoveAt("aboveBelowButton", 500);
						doh.robot.mouseClick({left:true}, 500);
						doh.robot.sequence(function(){ dijit.byId("test1").focus();}, 500);

						doh.robot.sequence(d.getTestCallback(function(){
							testAboveBelow(dijit.byId("test1"));
						}), 500);
						return d;
					}
				}];
				var tooltip_above_below = [{
					name: "test1_ab",
					timeout: 5000,
					runTest: function(){
						var d = new doh.Deferred();
						
						doh.robot.sequence(function(){ dijit.byId("test1").focus();}, 500);
						doh.robot.keyPress("a", 1000);
						doh.robot.sequence(function(){ dijit.byId("test1").focus();}, 500);

						doh.robot.sequence(d.getTestCallback(function(){
							testAboveBelow(dijit.byId("test1"));
						}), 500);
						return d;
					}
				}];

				// rest of tests
				for(var i=2; i<=21; i++){
					// FIXME: why do we omit the big textbox?
					if(i==7){ continue; }
					tooltip_left_right.push({
						name: "test"+i,
						widget: "test"+i,
						timeout: 3000,
						runTest: function(){
							var d = new doh.Deferred();
							var widget = this.widget;
							doh.robot.sequence(function(){ dijit.byId(widget).focus(); }, 500);
							
							doh.robot.sequence(d.getTestCallback(function(){
								testRightOrLeft(dijit.byId(widget));
							}), 500);
							return d;
						}
					});
					tooltip_left_right_small.push({
						name: "test"+i+"_lrs",
						widget: "test"+i,
						timeout: 3000,
						runTest: function(){
							var d = new doh.Deferred();
							var widget = this.widget;
							doh.robot.sequence(function(){ dijit.byId(widget).focus(); }, 500);

							doh.robot.sequence(d.getTestCallback(function(){
								testRightOrLeft(dijit.byId(widget));
							}), 500);
							return d;
						}
					});
					tooltip_above_below_small.push({
						name: "test"+i+"_abs",
						widget: "test"+i,
						timeout: 3000,
						runTest: function(){
							var d = new doh.Deferred();
							var widget = this.widget;
							doh.robot.sequence(function(){ dijit.byId(widget).focus(); }, 500);

							doh.robot.sequence(d.getTestCallback(function(){
								testAboveBelow(dijit.byId(widget));
							}), 500);
							return d;
						}
					});
					tooltip_above_below.push({
						name: "test"+i+"_ab",
						widget: "test"+i,
						timeout: 5000,
						runTest: function(){
							var d = new doh.Deferred();
							var widget = this.widget;
							doh.robot.sequence(function(){ dijit.byId(widget).focus();}, 500);
							doh.robot.keyPress("a", 1000);
							doh.robot.sequence(function(){ dijit.byId(widget).focus();}, 500);

							doh.robot.sequence(d.getTestCallback(function(){
								testAboveBelow(dijit.byId(widget));
							}), 500);
							return d;
						}
					});
				}
				
				doh.register("tooltip_left_right", tooltip_left_right);
				doh.register("tooltip_left_right_small", tooltip_left_right_small);
				doh.register("tooltip_above_below_small", tooltip_above_below_small);
				doh.register("tooltip_above_below", tooltip_above_below);
				doh.run();
			});
		</script>
	</head>
</html>
